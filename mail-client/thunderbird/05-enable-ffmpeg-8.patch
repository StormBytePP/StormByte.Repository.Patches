From 6aff720ee5acf233af7ff3cb45721a485fd671fa Mon Sep 17 00:00:00 2001
From: Landry Breuil <landry@openbsd.org>
Date: Mon, 24 Nov 2025 15:38:14 +0000
Subject: [PATCH] Bug 1962139 - Enable ffmpeg8 support in
 FFmpegRuntimeLinker.cpp r=media-playback-reviewers,padenot

Differential Revision: https://phabricator.services.mozilla.com/D272256
---
 dom/media/platforms/ffmpeg/FFmpegRuntimeLinker.cpp | 13 ++++++++++++-
 dom/media/platforms/ffmpeg/moz.build               |  1 +
 2 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/dom/media/platforms/ffmpeg/FFmpegRuntimeLinker.cpp b/dom/media/platforms/ffmpeg/FFmpegRuntimeLinker.cpp
index 79056313a62d1..97f1ee92e50ad 100644
--- a/dom/media/platforms/ffmpeg/FFmpegRuntimeLinker.cpp
+++ b/dom/media/platforms/ffmpeg/FFmpegRuntimeLinker.cpp
@@ -34,6 +34,7 @@ static FFmpegLibWrapper sLibAV;
 static const char* sLibs[] = {
 // clang-format off
 #if defined(XP_DARWIN)
+  "libavcodec.62.dylib",
   "libavcodec.61.dylib",
   "libavcodec.60.dylib",
   "libavcodec.59.dylib",
@@ -44,9 +45,10 @@ static const char* sLibs[] = {
   "libavcodec.54.dylib",
   "libavcodec.53.dylib",
 #elif defined(XP_OPENBSD)
-  "libavcodec.so", // OpenBSD hardly controls the major/minor library version
+  "libavcodec.so", // OpenBSD port controls the major/minor library version
                    // of ffmpeg and update it regulary on ABI/API changes
 #else
+  "libavcodec.so.62",
   "libavcodec.so.61",
   "libavcodec.so.60",
   "libavcodec.so.59",
@@ -119,6 +121,9 @@ bool FFmpegRuntimeLinker::Init() {
             case 61:
               FFmpegDecoderModule<61>::Init(&sLibAV);
               break;
+            case 62:
+              FFmpegDecoderModule<62>::Init(&sLibAV);
+              break;
           }
           return true;
         case FFmpegLibWrapper::LinkResult::NoProvidedLib:
@@ -209,6 +214,9 @@ already_AddRefed<PlatformDecoderModule> FFmpegRuntimeLinker::CreateDecoder() {
     case 61:
       module = FFmpegDecoderModule<61>::Create(&sLibAV);
       break;
+    case 62:
+      module = FFmpegDecoderModule<62>::Create(&sLibAV);
+      break;
     default:
       module = nullptr;
   }
@@ -247,6 +255,9 @@ already_AddRefed<PlatformEncoderModule> FFmpegRuntimeLinker::CreateEncoder() {
     case 61:
       module = FFmpegEncoderModule<61>::Create(&sLibAV);
       break;
+    case 62:
+      module = FFmpegEncoderModule<62>::Create(&sLibAV);
+      break;
     default:
       module = nullptr;
   }
diff --git a/dom/media/platforms/ffmpeg/moz.build b/dom/media/platforms/ffmpeg/moz.build
index 1ce048ffead4f..ec28c9f2fe0de 100644
--- a/dom/media/platforms/ffmpeg/moz.build
+++ b/dom/media/platforms/ffmpeg/moz.build
@@ -17,6 +17,7 @@ DIRS += [
     "ffmpeg59",
     "ffmpeg60",
     "ffmpeg61",
+    "ffmpeg62",
 ]
 
 UNIFIED_SOURCES += ["FFmpegRuntimeLinker.cpp"]
